<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FixZen - Premium Access</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Playfair+Display:ital,wght@1,600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'brand-olive': '#5D5646',
                        'brand-gold': '#A07D54',
                        'brand-cream': '#F8F5F0',
                        'brand-dark': '#2D2B28',
                        'brand-beige': '#DFD4C3'
                    },
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'], 
                        serif: ['"Playfair Display"', 'serif'] 
                    }
                }
            }
        }
    </script>

    <style>
        [x-cloak] { display: none !important; }
        body { background-color: #F8F5F0; }
        .fixzen-input {
            width: 100%; padding: 1rem 1.25rem; border-radius: 1.2rem;
            border: 2px solid #DFD4C3; background: white;
            font-size: 0.875rem; font-weight: 600; outline: none; transition: all 0.3s ease;
        }
        .fixzen-input:focus { border-color: #A07D54; box-shadow: 0 0 0 4px rgba(160, 125, 84, 0.1); }
        .input-label {
            display: block; font-size: 0.65rem; font-weight: 800; text-transform: uppercase;
            letter-spacing: 0.15em; color: #A07D54; margin-bottom: 0.5rem; margin-left: 0.5rem;
        }
        .otp-box {
            width: 100%; text-align: center; letter-spacing: 0.5em; font-size: 1.5rem;
            border: 2px dashed #A07D54; background: rgba(160, 125, 84, 0.05);
        }
        .btn-primary {
            width: 100%; padding: 1.1rem; border-radius: 1.2rem; background-color: #5D5646;
            color: white; font-weight: 800; font-size: 0.75rem; text-transform: uppercase;
            letter-spacing: 0.2em; transition: all 0.3s ease; display: flex;
            align-items: center; justify-content: center; gap: 0.5rem;
        }
        .loader {
            border: 2px solid #f3f3f3; border-top: 2px solid #A07D54;
            border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<!-- SAME HEAD, SAME STYLES, SAME UI ABOVE â€” NO CHANGES -->

<body
class="min-h-screen flex items-center justify-center font-sans"
x-data="{
  step: 'choose',
  isNewUser: false,
  loading: false,
  message: '',
  showPassword: false,
  form: { name:'', phone:'', user:'', pass:'', otp:'' },

  normalizePhone() {
    return '+91' + this.form.phone.trim();
  },


    async getLatLngFromAddress(address) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;

    const response = await fetch(url);
    const data = await response.json();

    if (!data || data.length === 0) {
      throw new Error('ADDRESS NOT FOUND');
    }

    return {
      lat: data[0].lat,
      lon: data[0].lon
    };
  },


  async handleAction() {
    this.message = '';
    if (!this.form.phone || this.form.phone.length !== 10) {
      this.message = 'ENTER VALID PHONE NUMBER';
      return;
    }

    this.loading = true;
    try {
      const phone = this.normalizePhone();

      const { data: existingUser, error } = await supabase
        .from('profiles')
        .select('id')
        .eq('phone', phone)
        .maybeSingle();

      if (error) throw error;

      if (this.isNewUser) {
        if (existingUser) {
          this.message = 'ACCOUNT ALREADY EXISTS';
          this.loading = false;
          return;
        }

        const { error: otpError } = await supabase.auth.signInWithOtp({ phone });
        if (otpError) throw otpError;

        this.step = 'otp';
      } else {
        if (!existingUser) {
          this.message = 'NO ACCOUNT FOUND';
          this.loading = false;
          return;
        }
        this.showPassword = true;
      }
    } catch (err) {
      this.message = err.message.toUpperCase();
    } finally {
      this.loading = false;
    }
  },

  async loginWithPassword() {
    if (!this.form.pass || this.form.pass.length < 6) {
      this.message = 'ENTER PASSWORD';
      return;
    }

    this.loading = true;
    this.message = '';
    try {
      const { error } = await supabase.auth.signInWithPassword({
        phone: this.normalizePhone(),
        password: this.form.pass
      });
      if (error) throw error;

      window.location.href = 'index.html';
    } catch {
      this.message = 'INVALID LOGIN CREDENTIALS';
    } finally {
      this.loading = false;
    }
  },

  async verifyOtp() {
    if (!this.form.otp || this.form.otp.length !== 6) {
      this.message = 'ENTER VALID OTP';
      return;
    }

    this.loading = true;
    this.message = '';
    try {
      const phone = this.normalizePhone();

      const { data, error } = await supabase.auth.verifyOtp({
        phone,
        token: this.form.otp,
        type: 'sms'
      });
      if (error) throw error;

      const user = data.user;
      if (!user) throw new Error('USER NOT FOUND');

      // ðŸ”’ HARD BLOCK â€” CHECK AGAIN
      const { data: alreadyExists } = await supabase
        .from('profiles')
        .select('id')
        .eq('phone', phone)
        .maybeSingle();

      if (alreadyExists) {
        this.message = 'ACCOUNT ALREADY EXISTS';
        return;
      }

      await supabase.auth.updateUser({ password: this.form.pass });
// ðŸ“ Convert address to lat/lng
const location = await this.getLatLngFromAddress(this.form.address);

const { error: profileError } = await supabase.from('profiles').insert({
  id: user.id,
  full_name: this.form.name,
  username: this.form.user,
  phone,
  address: this.form.address,
  latitude: location.lat,
  longitude: location.lon
});


      if (profileError) {
        this.message = 'ACCOUNT ALREADY EXISTS';
        return;
      }

      window.location.href = 'index.html';
    } catch (err) {
      this.message = err.message.toUpperCase();
    } finally {
      this.loading = false;
    }
  }
}"
>


<div class="w-full max-w-md animate__animated animate__fadeIn">

    <!-- LOGO -->
    <div class="text-center mb-8">
        <img src="fixzen.png" alt="FixZen" class="w-20 h-20 rounded-full mx-auto mb-4 shadow-xl border-2 border-white object-cover">
        <h1 class="text-3xl font-extrabold tracking-[0.2em] text-brand-olive uppercase">FixZen</h1>
        <p class="text-[10px] font-bold text-brand-gold/60 uppercase tracking-[0.3em] mt-1">Premium Home Care</p>
    </div>

    <div class="bg-white/90 backdrop-blur-xl p-8 rounded-[2.5rem] shadow-2xl border border-white">

        <!-- CHOOSE LOGIN OR SIGNUP -->
        <div x-show="step==='choose'" class="space-y-6 text-center">
            <h2 class="font-serif italic text-2xl text-brand-olive mb-6">Welcome to FixZen</h2>
            <button @click="isNewUser=true; step='auth'; showPassword=false" class="btn-primary">Create New Account</button>
            <button @click="isNewUser=false; step='auth'; showPassword=false" class="btn-primary">Login</button>
        </div>

        <!-- AUTH FORM -->
        <div x-show="step==='auth'" x-cloak>
            <h2 class="font-serif italic text-2xl text-brand-olive text-center mb-8"
                x-text="isNewUser ? 'Create Account' : 'Welcome Back'"></h2>

            <div class="space-y-4">
                <template x-if="isNewUser">
                    <div class="space-y-4">
                        <div>
                            <label class="input-label">Full Name</label>
                            <input type="text" x-model="form.name" class="fixzen-input" placeholder="Rahul Sharma">
                        </div>
                        <div>
                            <label class="input-label">Username</label>
                            <input type="text" x-model="form.user" class="fixzen-input" placeholder="username">
                        </div>
                        <div>
                            <label class="input-label">Password</label>
                            <input type="password" x-model="form.pass" class="fixzen-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                    </div>
                </template>

                <!-- Login password field -->
                <div x-show="showPassword && !isNewUser">
                    <label class="input-label">Password</label>
                    <input type="password" x-model="form.pass" class="fixzen-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>

                <div>
                    <label class="input-label">Mobile Number</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-brand-gold font-bold text-xs">+91</span>
                        <input type="tel" x-model="form.phone" class="fixzen-input pl-12" placeholder="9876543210">
                    </div>
                </div>













                <!-- Address Field -->
<div>
  <label class="input-label">Address</label>
  <textarea 
    x-model="form.address"
    rows="3"
    class="fixzen-input resize-none"
    placeholder="House no, Street, Area, City, Pincode">
  </textarea>
</div>

<!-- Address Button -->
<button 
  type="button"
  @click="form.address = form.address.trim()"
  class="btn-primary mt-2 bg-brand-gold">
  <i class="fa-solid fa-location-dot"></i>
  Save Address
</button>


















                <button x-show="!showPassword || isNewUser" @click="handleAction()" class="btn-primary mt-4 shadow-lg" :disabled="loading">
                    <span x-show="!loading" x-text="isNewUser ? 'Send Verification' : 'Check Account'"></span>
                    <div x-show="loading" class="loader"></div>
                </button>

                <button x-show="showPassword && !isNewUser" @click="loginWithPassword()" class="btn-primary mt-4 shadow-lg" :disabled="loading">
                    <span x-show="!loading">Sign In</span>
                    <div x-show="loading" class="loader"></div>
                </button>

                <p x-show="message" x-text="message" class="text-[10px] text-red-500 font-bold text-center uppercase tracking-widest mt-4"></p>

                <div class="mt-6 pt-6 border-t border-brand-beige/30 text-center">
                    <button @click="step='choose'; message=''; showPassword=false" class="text-xs font-bold text-brand-gold hover:underline uppercase tracking-widest">
                        <span x-text="isNewUser ? 'Already a member? Sign In' : 'New User? Create Account'"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- OTP Verification -->
        <div x-show="step==='otp'" x-cloak class="text-center">
            <div class="w-16 h-16 bg-brand-cream rounded-full flex items-center justify-center text-brand-gold mx-auto mb-6">
                <i class="fa-solid fa-mobile-screen-button text-2xl"></i>
            </div>
            <h2 class="font-serif italic text-2xl text-brand-olive mb-2">Verify Mobile</h2>
            <p class="text-[10px] font-bold text-brand-dark/40 uppercase tracking-widest mb-8">
                Code sent to +91 <span x-text="form.phone"></span>
            </p>

            <div class="space-y-6">
                <input type="text" x-model="form.otp" maxlength="6" class="fixzen-input otp-box" placeholder="000000">
                <button @click="verifyOtp()" class="btn-primary bg-brand-gold" :disabled="loading">
                    <span x-show="!loading">Verify & Join</span>
                    <div x-show="loading" class="loader"></div>
                </button>
                <p x-show="message" x-text="message" class="text-[10px] text-red-500 font-bold text-center uppercase tracking-widest mt-2"></p>
                <button @click="step='auth'; message=''" class="text-[10px] font-bold text-brand-olive/50 uppercase tracking-widest hover:text-brand-gold">
                    Change Details
                </button>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const supabase = createClient(
      'https://kzxdxnxgouthsywbsnvl.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6eGR4bnhnb3V0aHN5d2JzbnZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMTczMzIsImV4cCI6MjA4MTg5MzMzMn0.nqzn89vmTFKVNuZPHfGRxdTg6UHT6GMud238rr49qag'
      
    )
    window.supabase = supabase;
</script>

</body>
</html>