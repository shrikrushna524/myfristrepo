<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Live Tracker - Route to User</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100vw; }
        .info-panel {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            width: 85%;
            max-width: 400px;
        }
        #status { color: #A07D54; font-weight: bold; }
    </style>
</head>
<body>

    <div class="info-panel">
        <b id="target-name">Loading Destination...</b><br>
        <small id="status">Connecting to Database...</small>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // 1. DATABASE CONFIGURATION
        const SUPABASE_URL = 'https://kzxdxnxgouthsywbsnvl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6eGR4bnhnb3V0aHN5d2JzbnZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMTczMzIsImV4cCI6MjA4MTg5MzMzMn0.nqzn89vmTFKVNuZPHfGRxdTg6UHT6GMud238rr49qag';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. MAP & TRACKING VARIABLES
        let destLat, destLng;
        let userMarker, routingControl;
        const map = L.map('map').setView([0, 0], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // 3. FETCH DESTINATION FROM SUPABASE
        async function loadDestination(username) {
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('full_name, latitude, longitude')
                    .eq('username', username)
                    .single();

                if (error) throw error;

                if (data) {
                    destLat = parseFloat(data.latitude);
                    destLng = parseFloat(data.longitude);
                    
                    document.getElementById('target-name').innerText = `Routing to: ${data.full_name}`;
                    document.getElementById('status').innerText = "Waiting for your GPS...";
                    
                    // Add a marker for the destination
                    L.marker([destLat, destLng]).addTo(map).bindPopup(`<b>${data.full_name}</b><br>Destination`).openPopup();

                    startTracking(); 
                }
            } catch (err) {
                console.error("Fetch Error:", err.message);
                document.getElementById('status').innerText = "User not found in database.";
            }
        }

        // 4. GPS SUCCESS CALLBACK
        function success(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            document.getElementById('status').innerText = `Your Location: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;

            // Update User Marker
            if (!userMarker) {
                userMarker = L.marker([lat, lng]).addTo(map).bindPopup("You").openPopup();
                map.setView([lat, lng], 15);
            } else {
                userMarker.setLatLng([lat, lng]);
            }

            // Update Route
            if (destLat && destLng) {
                if (routingControl) {
                    routingControl.setWaypoints([
                        L.latLng(lat, lng),
                        L.latLng(destLat, destLng)
                    ]);
                } else {
                    routingControl = L.Routing.control({
                        waypoints: [
                            L.latLng(lat, lng),
                            L.latLng(destLat, destLng)
                        ],
                        createMarker: function() { return null; }, // We use our own markers
                        routeWhileDragging: false,
                        addWaypoints: false,
                        show: false // Hide text instructions for a cleaner map
                    }).addTo(map);
                }
            }
        }

        function error(err) {
            console.error("GPS Error:", err);
            document.getElementById('status').innerText = "Please enable GPS/Location.";
        }

        function startTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(success, error, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            } else {
                alert("Geolocation not supported.");
            }
        }

        // --- EXECUTION ---
        // Change 'john_doe' to whichever username you want to find in your database
        loadDestination('shrikrushna07'); 


        // --- EXECUTION ---
// This looks for ?user=xxxx in your browser address bar
const urlParams = new URLSearchParams(window.location.search);
const usernameFromUrl = urlParams.get('user');

if (usernameFromUrl) {
    loadDestination(usernameFromUrl);
} else {
    document.getElementById('target-name').innerText = "No User Specified";
    document.getElementById('status').innerText = "Add ?user=username to the URL";
}

    </script>
</body>
</html>